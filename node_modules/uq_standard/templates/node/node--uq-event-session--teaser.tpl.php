<?php

/**
 * @file
 * Template for teaser viewmode of uq_event_session content type.
 */
$current_date = strtotime("now");
$registration_required = render($content['field_uq_session_reg_required']);
?>
<?php if (!empty($content)): ?>
<div class="event-session--teaser">
  <div class="row event-session__wrapper">
    <div class="event-session <?php if (!empty($content['field_uq_session_teaser_image'])):
      print 'event-session--has-image';
    endif; ?>">
      <?php if (!empty($content['field_uq_session_teaser_image'])): ?>
      <div class="column small-5 medium-3 event-session__media">
        <div class="event-session__teaser-image">
          <?php print render($content['field_uq_session_teaser_image']); ?>
        </div>
      </div>
      <div class="column small-7 medium-9 event-session__content">
        <?php else: ?>
        <div class="column small-12 event-session__content">
          <?php endif; ?>
          <!-- Session Title -->
          <h3 class="event-session__title">
            <a href="<?php print render($variables['node_url']); ?>">
              <?php print render($variables['title']); ?>
            </a>
          </h3>
          <div class="row collapse small-collapse">
            <div class="column medium-9">
              <!-- Session Status -->
              <?php if (!empty($content['field_uq_session_event_status']) && $content['field_uq_session_event_status']['#items'][0]['taxonomy_term']->name !== 'Scheduled'): ?>
                <div class="event-session__status <?php if ($content['field_uq_session_event_status']['#items'][0]['taxonomy_term']->name == 'Cancelled'): ?>event-session__status--cancelled<?php
                endif; ?>">
                  <?php print render($content['field_uq_session_event_status']); ?>
                </div>
              <?php endif; ?>
              <!-- Session Date -->
              <?php if (!empty($content['field_uq_session_event_date'])): ?>
                <div class="event-session__date">
                  <?php print render($content['field_uq_session_event_date']); ?>
                </div>
              <?php endif; ?>
              <!-- Calendar link -->
              <?php if (!empty($nid) && drupal_valid_path('event/session/' . $nid . '/calendar.ics')): ?>
                <div class="event-session__calendar-add-link">
                  <?php print render($content['uq_ical_link']); ?>
                </div>
              <?php endif; ?>
              <!-- Parent event link -->
              <?php if (!empty($parent_id) && !empty($parent)): ?>
                <div class="event-session__parent-title">
                  in <a href="<?php print '/' . drupal_get_path_alias('node/' . $parent_id) ?>">
                    <?php print $parent->title; ?>
                  </a>
                </div>
              <?php endif; ?>
              <!-- Session Summary -->
              <?php if (!empty($content['field_uq_session_summary'])): ?>
                <div class="event-session__summary">
                  <?php print render($content['field_uq_session_summary']); ?>
                </div>
              <?php endif; ?>
            </div>
            <!-- Session Register Button -->
            <?php if ($registration_required == TRUE && !empty($content['field_uq_session_reg_url']) && isset($content['field_uq_session_event_status']) && $content['field_uq_session_event_status']['#items'][0]['taxonomy_term']->name === 'Scheduled'): ?>
              <?php
              // @TODO: If the rendering of field_uq_session_reg_date is fixed, then we can use the below code.
              // if (!empty($content['field_uq_session_reg_date'])) {
              //   $reg_value = render($content['field_uq_session_reg_date']);
              //   $reg_array = explode(" to ", $reg_value);
              //   if (isset($reg_array[1]) && $reg_array[0] != $reg_array[1]) {
              //     $reg_date = strtotime($reg_array[1]);
              //   }
              //   else {
              //     $reg_date = strtotime($reg_array[0]);
              //   }
              // }
              if (isset($variables['field_uq_session_reg_date'][LANGUAGE_NONE][0]['value2'])) {
                $date = new DateTime($variables['field_uq_session_reg_date'][LANGUAGE_NONE][0]['value2'], new DateTimeZone($variables['field_uq_session_reg_date'][LANGUAGE_NONE][0]['timezone_db']));
                $date->setTimeZone(new DateTimeZone($variables['field_uq_session_reg_date'][LANGUAGE_NONE][0]['timezone']));
                $reg_date = $date->format('U');
              } elseif (isset($variables['field_uq_session_reg_date'][LANGUAGE_NONE][0]['value'])) {
                $date = new DateTime($variables['field_uq_session_reg_date'][LANGUAGE_NONE][0]['value'], new DateTimeZone($variables['field_uq_session_reg_date'][LANGUAGE_NONE][0]['timezone_db']));
                $date->setTimeZone(new DateTimeZone($variables['field_uq_session_reg_date'][LANGUAGE_NONE][0]['timezone']));
                $reg_date = $date->format('U');
              } else {
                $reg_date = FALSE;
              }
              ?>
              <?php
              // @TODO: If the rendering of field_uq_session_reg_date is fixed, then we can use the below code.
              // if (empty($content['field_uq_session_reg_date']) || $reg_date > $current_date) :
              ?>
              <?php if (!$reg_date || $reg_date > $current_date) : ?>
                <div class="column medium-3 hide-for-small">
                  <div class="event-session__reg_url right">
                    <a href="<?php print render($content['field_uq_session_reg_url']); ?>"
                       class="event__register-link button">Register</a>
                  </div>
                </div>
              <?php endif; ?>
            <?php endif; ?>
          </div>
        </div>
      </div>
    </div>
  </div>
  <?php endif; ?>
