<?php

/**
 * @file
 * Theme setting callbacks for the uq_standard theme.
 */

/**
 * Implements hook_form_system_theme_settings_alter().
 */
function uq_standard_form_system_theme_settings_alter(&$form, &$form_state, $form_id = NULL) {
  // Work-around for a core bug affecting admin themes see issue #943212 at
  // https://www.drupal.org/node/943212.
  if (isset($form_id)) {
    return;
  }

  // Create the form using Forms API.
  $form['themedev'] = array(
    '#type' => 'fieldset',
    '#title' => t('UQ Standard display options'),
  );
  $form['themedev']['uq_standard_hide_panel_page_title'] = array(
    '#type' => 'checkbox',
    '#title' => t('Hide page title on all panel pages.'),
    '#default_value' => theme_get_setting('uq_standard_hide_panel_page_title'),
    '#description' => t('Hide page titles for all <a href="!link">panel pages</a>, developers must place the title as part of the template e.g., as a token.', array('!link' => '/admin/structure/pages')),
  );
  $form['themedev']['uq_standard_hide_panel_primary_tabs'] = array(
    '#type' => 'checkbox',
    '#title' => t('Hide primary tabs from page.tpl.php on all panel pages.'),
    '#default_value' => theme_get_setting('uq_standard_hide_panel_primary_tabs'),
    '#description' => t('Hide primary tabs for all <a href="!link">panel pages</a>, developers must place the tabs as part of the template e.g., as a Page element.', array('!link' => '/admin/structure/pages')),
  );
  $form['themedev']['uq_standard_hide_site_search'] = array(
    '#type' => 'checkbox',
    '#title' => t('Hide UQ Google Search'),
    '#default_value' => theme_get_setting('uq_standard_hide_site_search'),
    '#description' => t('Hide site search in the corporate header. To override see theme <small><code>uq_standard_site_search()</code> in <code>template.php</code></small>'),
  );

  drupal_add_css(drupal_get_path('theme', 'uq_standard') . '/css/site-header.css');

  $theme_settings_path = drupal_get_path('theme', 'uq_standard') . '/theme-settings.php';
  $form_state['build_info']['files'][] = $theme_settings_path;

  $form['site_information'] = array(
    '#type' => 'fieldset',
    '#title' => 'Site information ',
    '#prefix' => '<div class="large-12">',
    '#suffix' => '</div>',
    '#weight' => -10,
  );

  $form['site_information']['site_title'] = array(
    '#type' => 'fieldset',
    '#title' => 'Site title ',
    '#prefix' => '<div class="large-6 columns">',
    '#suffix' => '</div>',
  );

  $prefix_option = array();
  $prefix_option['School of'] = "School of";
  $prefix_option['Faculty of'] = "Faculty of";
  $prefix_option['Institute for'] = "Institute for";
  $prefix_option['Institute of'] = "Institute of";
  $prefix_option['Australian Institute for'] = "Australian Institute for";
  $prefix_option['Centre for'] = "Centre for";
  $prefix_option['Centre of'] = "Centre of";
  $prefix_option['Office of'] = "Office of";
  $prefix_option['Division of'] = "Division of";

  $site_prefix = html_entity_decode(theme_get_setting('site_prefix', 'uq_standard'));
  $site_display = html_entity_decode(theme_get_setting('site_display', 'uq_standard'));
  $site_acronym = html_entity_decode(theme_get_setting('site_acronym', 'uq_standard'));
  $site_name = html_entity_decode(variable_get('site_name', ''));

  if ($site_display) {
    $site_name = $site_display;
    if ($site_prefix) {
      $site_name = $site_prefix . " " . $site_display;
    }
  }

  $data['site_name'] = $site_name;
  $data['prefix'] = $site_prefix;
  $data['title'] = $site_display;
  $data['acronym'] = $site_acronym;

  $form['site_information']['site_title']['site_prefix'] = array(
    '#type' => 'select',
    '#title' => 'Prefix',
    '#options' => $prefix_option,
    '#required' => FALSE,
    "#empty_option" => t('- None -'),
    '#default_value' => $site_prefix,
    '#weight' => -30,
    '#ajax' => array(
      'callback' => 'uq_standard_update_callback',
      'wrapper' => 'site-title',
      'progress' => array(
        'message' => '',
        'type' => 'throbber',
      ),
    ),
  );

  $form['site_information']['site_title']['site_display'] = array(
    '#type' => 'textarea',
    '#title' => 'Display title',
    '#required' => TRUE,
    '#rows' => 2,
    '#resizable' => 0,
    '#default_value' => ($site_display ? $site_display : $site_name),
    '#weight' => -20,
    '#ajax' => array(
      'callback' => 'uq_standard_update_callback',
      'wrapper' => 'site-title',
      'progress' => array(
        'message' => '',
        'type' => 'throbber',
      ),
    ),
  );

  $form['site_information']['site_title']['site_acronym'] = array(
    '#type' => 'textfield',
    '#title' => 'Acronym',
    '#required' => FALSE,
    '#default_value' => $site_acronym,
    '#weight' => -10,
    '#ajax' => array(
      'callback' => 'uq_standard_update_callback',
      'wrapper' => 'site-title',
      'progress' => array(
        'message' => '',
        'type' => 'throbber',
      ),
    ),
  );

  $form['site_information']['site_title']['site_name'] = array(
    '#type' => 'hidden',
    '#title' => 'Site name',
    '#default_value' => $site_name,
    '#prefix' => '<div id="site-name">',
    '#suffix' => '</div>',
    '#required' => TRUE,
  );

  $form['site_information']['demo'] = array(
    '#type' => 'fieldset',
    '#prefix' => '<div class="large-6 columns">',
    '#suffix' => '</div>',
    '#attributes' => array('class' => array('site-header')),
  );

  $form['site_information']['demo']['demo_title'] = array(
    '#prefix' => '<div id="demo-title">',
    '#suffix' => '</div>',
    '#markup' => uq_standard_demo_render($data, "regular"),
  );

  $form['site_information']['demo']['demo_abbr'] = array(
    '#prefix' => '<div id="demo-abbr">',
    '#suffix' => '</div>',
    '#markup' => uq_standard_demo_render($data, "small"),
  );

  $form['#submit'][] = 'uq_standard_form_system_theme_settings_set_variable';

}

/**
 * A callback function when prefix/title/acronym is changed.
 */
function uq_standard_update_callback($form, &$form_state) {

  if ($form_state['values']['site_prefix'] && $form_state['values']['site_display']) {
    $data['site_name'] = $form_state['values']['site_prefix'] . " " . $form_state['values']['site_display'];
  }
  elseif ($form_state['values']['site_display']) {
    $data['site_name'] = $form_state['values']['site_display'];
  }
  else {
    $data['site_name'] = variable_get('site_name', '');
  }

  $data['prefix'] = $form_state['values']['site_prefix'];
  $data['title'] = $form_state['values']['site_display'];
  $data['acronym'] = $form_state['values']['site_acronym'];

  $form['site_information']['demo']['demo_title'] = array(
    '#prefix' => '<div id="demo-title">',
    '#suffix' => '</div>',
    '#markup' => uq_standard_demo_render($data, "regular"),
  );

  $form['site_information']['demo']['demo_abbr'] = array(
    '#prefix' => '<div id="demo-abbr">',
    '#suffix' => '</div>',
    '#markup' => uq_standard_demo_render($data, "small"),
  );

  return array(
    '#type' => 'ajax',
    '#commands' => array(
      ajax_command_replace("#demo-title", render($form['site_information']['demo']['demo_title'])),
      ajax_command_replace("#demo-abbr", render($form['site_information']['demo']['demo_abbr'])),
    ),
  );
}

/**
 * An add on submit handler to set the variable of site name.
 */
function uq_standard_form_system_theme_settings_set_variable(&$form, &$form_state) {
  if ($form_state['values']['site_prefix'] && $form_state['values']['site_display']) {
    $site_name = $form_state['values']['site_prefix'] . " " . $form_state['values']['site_display'];
  }
  elseif ($form_state['values']['site_display']) {
    $site_name = $form_state['values']['site_display'];
  }
  if ($site_name) {
    variable_set('site_name', htmlentities($site_name));
  }

  $form_state['values']['site_prefix'] = htmlentities($form_state['values']['site_prefix']);
  $form_state['values']['site_display'] = htmlentities($form_state['values']['site_display']);
  $form_state['values']['site_acronym'] = htmlentities($form_state['values']['site_acronym']);
}

/**
 * Render the demo of title display on the site condiguration page.
 */
function uq_standard_demo_render($data, $mode) {
  $site_name = $data['site_name'];
  $prefix = ($data['prefix'] ? $data['prefix'] : "");
  $title = ($data['title'] ? uq_standard_newline($data['title']) : $site_name);
  $acronym = ($data['acronym'] && $data['title'] ? $data['acronym'] : $title);

  switch ($mode) {
    case 'small':
      $display = $acronym;
      if ($data['acronym']) {
        $prefix = '';
      }
      break;

    case 'regular':
      $display = $title;
      break;
  }
  if ($prefix && $display) {
    $format = '<div class="site-header"><div class="site-header__content"><div class="columns large-12"><a class="uq-logo" title="UQ Homepage" href="#">The University of Queensland</a><div class="site-title has-prefix"><a class="site-title__link" rel="home" title="!site_name" href="#"><span class="site-title__prefix">!site_prefix</span> !site_display</a></div></div></div></div>';
  }
  elseif (strpos($display, PHP_EOL)) {
    $format = '<div class="site-header"><div class="site-header__content"><div class="columns large-12"><a class="uq-logo" title="UQ Homepage" href="#">The University of Queensland</a><div class="site-title has-2-lines"><a class="site-title__link" rel="home" title="!site_name" href="#">!site_display</a></div></div></div></div>';
  }
  else {
    $format = '<div class="site-header"><div class="site-header__content"><div class="columns large-12"><a class="uq-logo" title="UQ Homepage" href="#">The University of Queensland</a><div class="site-title"><a class="site-title__link" rel="home" title="!site_name" href="#">!site_display</a></div></div></div></div>';
  }
  $title = t($format, array(
    '!site_name' => $site_name,
    '!site_prefix' => $prefix,
    '!site_display' => $display,
  ));
  return $title;
}

/**
 * Function to limit the number of line breaks to one.
 */
function uq_standard_newline($text) {
  $first_pos = strpos($text, "\n");
  if ($first_pos) {
    $first_line = substr($text, 0, $first_pos + 2);
    $second_line = substr($text, $first_pos + 2);
    $second_line = str_replace('\n', '', $second_line);
    $text = nl2br($first_line) . $second_line;
  }
  return $text;
}
